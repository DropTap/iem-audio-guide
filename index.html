<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Audio Kings: Best Affordable IEMs in the Philippines</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Marked for Markdown parsing in AI response -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0F172A; color: #F3F4F6; }
        .gradient-text {
            background: linear-gradient(to right, #3B82F6, #8B5CF6, #F472B6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .card {
            background-color: #1E293B; /* Slate 800 */
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #334155;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 650px;
            margin-left: auto;
            margin-right: auto;
            height: 400px;
            max-height: 450px;
        }
        @media (max-width: 640px) {
            .chart-container { height: 300px; }
        }
        
        /* AI Feature Specific Styles */
        .ai-glow:focus-within {
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
            border-color: #3B82F6;
        }
        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: #94a3b8;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
            margin: 0 2px;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        /* Markdown Styles for AI Response */
        .ai-response strong { color: #3B82F6; font-weight: 700; }
        .ai-response em { color: #F472B6; font-style: italic; }
        .ai-response ul { list-style-type: disc; padding-left: 1.5rem; margin-top: 0.5rem; }
        .ai-response li { margin-bottom: 0.25rem; }
    </style>
</head>
<body class="antialiased selection:bg-pink-500 selection:text-white">

    <!-- Header Section -->
    <header class="py-12 px-4 text-center border-b border-gray-800 bg-gradient-to-b from-slate-900 to-slate-900">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-5xl md:text-6xl font-extrabold mb-4 tracking-tight">
                <span class="gradient-text">Budget Audio Kings</span>
            </h1>
            <p class="text-xl md:text-2xl text-gray-400 font-light mt-4">
                The Best Affordable IEMs in the Philippines (Under ‚Ç±1,500)
            </p>
            <div class="mt-8 flex justify-center space-x-4 text-sm font-semibold text-gray-500">
                <span class="px-3 py-1 bg-slate-800 rounded-full border border-slate-700">üéµ Hi-Res Audio</span>
                <span class="px-3 py-1 bg-slate-800 rounded-full border border-slate-700">üáµüá≠ Shopee/Lazada Ready</span>
                <span class="px-3 py-1 bg-slate-800 rounded-full border border-slate-700">üí∏ Wallet Friendly</span>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-12 space-y-16">

        <!-- Introduction -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-12 items-center">
            <div class="space-y-6">
                <h2 class="text-3xl font-bold text-white border-l-4 border-blue-500 pl-4">The Chi-Fi Revolution</h2>
                <p class="text-gray-300 leading-relaxed text-lg">
                    Gone are the days when good audio cost a fortune. The rise of "Chi-Fi" (Chinese Hi-Fi) has flooded the Philippine market with In-Ear Monitors (IEMs) that rival major brands costing 10x more. For students, gamers, and budding audiophiles, this is the golden age of high-fidelity audio on a shoestring budget.
                </p>
                <div class="card p-6 border-l-4 border-purple-500">
                    <h3 class="text-xl font-bold text-purple-400 mb-2">Why IEMs over Earbuds?</h3>
                    <ul class="space-y-2 text-gray-400">
                        <li>üîá <strong>Passive Isolation:</strong> Blocks out jeepney noise effectively.</li>
                        <li>üéº <strong>Driver Quality:</strong> Larger dynamic drivers for better bass.</li>
                        <li>üîå <strong>Modularity:</strong> Replaceable cables mean longer lifespan.</li>
                    </ul>
                </div>
            </div>
            
            <!-- Quick Stats Visualization -->
            <div class="card p-6 flex flex-col justify-center items-center text-center space-y-8">
                <div>
                    <div class="text-5xl font-bold text-blue-500">‚Ç±400 - ‚Ç±1.2k</div>
                    <div class="text-sm text-gray-400 uppercase tracking-wider mt-2">Sweet Spot Price Range</div>
                </div>
                <div>
                    <div class="text-5xl font-bold text-pink-500">5+</div>
                    <div class="text-sm text-gray-400 uppercase tracking-wider mt-2">Top Tier Models Available</div>
                </div>
                <div>
                    <div class="text-5xl font-bold text-purple-500">98%</div>
                    <div class="text-sm text-gray-400 uppercase tracking-wider mt-2">Positive Local Ratings</div>
                </div>
            </div>
        </section>

        <!-- Gemini AI Consultant Section -->
        <section id="ai-consultant" class="scroll-mt-24">
            <div class="bg-gradient-to-r from-slate-900 to-slate-800 rounded-2xl p-1 border border-blue-500/30 shadow-2xl shadow-blue-900/20">
                <div class="bg-slate-900 rounded-xl p-8 md:p-10">
                    <div class="flex flex-col md:flex-row gap-8">
                        <div class="md:w-1/3 space-y-4">
                            <h2 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400">
                                AI Audio Consultant ‚ú®
                            </h2>
                            <p class="text-gray-400 text-sm leading-relaxed">
                                Not sure which IEM is right for you? Or confused by terms like "V-Shape" or "Soundstage"?
                            </p>
                            <p class="text-gray-400 text-sm leading-relaxed">
                                Tell our <strong>Gemini-powered</strong> consultant what you listen to (e.g., "I like K-Pop and play Valorant") or ask a question!
                            </p>
                        </div>
                        <div class="md:w-2/3 space-y-4">
                            <div class="relative group ai-glow rounded-lg transition-all duration-300">
                                <textarea 
                                    id="userQuery" 
                                    rows="3" 
                                    class="w-full bg-slate-800 text-gray-200 border border-slate-700 rounded-lg p-4 focus:outline-none resize-none placeholder-gray-500 transition-colors"
                                    placeholder="e.g., 'I want lots of bass for EDM but under ‚Ç±800' or 'What is impedance?'"
                                ></textarea>
                                <div class="absolute bottom-3 right-3">
                                    <button 
                                        onclick="askGemini()" 
                                        class="bg-blue-600 hover:bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-full transition-all duration-200 flex items-center gap-2 shadow-lg shadow-blue-600/20"
                                    >
                                        <span>Ask AI</span>
                                        <span id="btn-sparkle">‚ú®</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Response Area -->
                            <div id="aiResultContainer" class="hidden">
                                <div class="bg-slate-800/50 border border-slate-700 rounded-lg p-6 relative">
                                    <div class="absolute -top-3 left-4 bg-slate-800 text-xs font-bold text-blue-400 px-2 py-1 border border-slate-700 rounded">
                                        GEMINI RECOMMENDATION
                                    </div>
                                    <div id="aiResponseText" class="text-gray-300 leading-relaxed text-sm ai-response">
                                        <!-- Content goes here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Loading State -->
                            <div id="aiLoading" class="hidden text-center py-4">
                                <div class="typing-indicator">
                                    <span></span><span></span><span></span>
                                </div>
                                <p class="text-xs text-gray-500 mt-2 animate-pulse">Analyzing audio preferences...</p>
                            </div>
                            
                             <!-- Error State -->
                             <div id="aiError" class="hidden bg-red-900/20 border border-red-500/30 text-red-400 p-4 rounded-lg text-sm">
                                Oops! The AI is having a bit of trouble connecting. Please try again in a moment.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Market Share / Popularity Section -->
        <section>
            <div class="max-w-3xl mx-auto text-center mb-10">
                <h2 class="text-3xl font-bold text-white mb-4">Brand Popularity in PH</h2>
                <p class="text-gray-400">
                    Based on search volume and sales data from local e-commerce platforms, these brands dominate the entry-level audio space. KZ (Knowledge Zenith) started the wave, but newer competitors like Moondrop and Tangzu are taking over with better tuning.
                </p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                <div class="chart-container">
                    <canvas id="popularityChart"></canvas>
                </div>
                <div class="space-y-4">
                    <div class="card p-4 flex items-start space-x-4 hover:bg-slate-700 transition">
                        <div class="text-3xl">üêØ</div>
                        <div>
                            <h4 class="font-bold text-blue-400">KZ (Knowledge Zenith)</h4>
                            <p class="text-sm text-gray-400">The veteran. Known for heavy bass and sharp treble. Ubiquitous availability.</p>
                        </div>
                    </div>
                    <div class="card p-4 flex items-start space-x-4 hover:bg-slate-700 transition">
                        <div class="text-3xl">üíß</div>
                        <div>
                            <h4 class="font-bold text-purple-400">Moondrop</h4>
                            <p class="text-sm text-gray-400">The aesthetic king. Famous for the "Anime Waifu" packaging and neutral, clean sound.</p>
                        </div>
                    </div>
                    <div class="card p-4 flex items-start space-x-4 hover:bg-slate-700 transition">
                        <div class="text-3xl">üë∏</div>
                        <div>
                            <h4 class="font-bold text-pink-400">Tangzu</h4>
                            <p class="text-sm text-gray-400">The rising star. Their "Wan'er" model is widely considered the best value all-rounder.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Price vs Performance Section -->
        <section class="bg-slate-900/50 p-8 rounded-2xl border border-slate-800">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-white mb-2">Price Landscape</h2>
                <p class="text-gray-400">
                    Comparing the average market price of the top 5 contenders. Note that despite the price differences, the audio quality gap is surprisingly small, making the cheaper options incredible value.
                </p>
            </div>
            <div class="chart-container">
                <canvas id="priceChart"></canvas>
            </div>
            <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-4 text-center text-sm text-gray-500">
                <p>Prices based on Lazada/Shopee PH averages</p>
                <p>Fluctuates during Payday Sales (15th/30th)</p>
                <p>Vouchers can lower these by ~10%</p>
            </div>
        </section>

        <!-- Technical Breakdown (Radar) -->
        <section>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 space-y-6">
                    <h2 class="text-3xl font-bold text-white">Sound Signature Face-Off</h2>
                    <p class="text-gray-400">
                        Not all IEMs sound the same. Your choice should depend on your music library.
                    </p>
                    <div class="space-y-4">
                        <div class="p-4 border-l-2 border-pink-500 bg-slate-800/50">
                            <h4 class="font-bold text-white">Tangzu Wan'er</h4>
                            <p class="text-sm text-gray-400">Warm & Relaxing. Best for Vocals, Pop, and OPM acoustics.</p>
                        </div>
                        <div class="p-4 border-l-2 border-blue-500 bg-slate-800/50">
                            <h4 class="font-bold text-white">7Hz Salnotes Zero</h4>
                            <p class="text-sm text-gray-400">Clean & Analytical. Best for detailed listening, classical, and gaming (footsteps).</p>
                        </div>
                        <div class="p-4 border-l-2 border-purple-500 bg-slate-800/50">
                            <h4 class="font-bold text-white">KZ Castor (Bass)</h4>
                            <p class="text-sm text-gray-400">Booming & Fun. Best for Hip-hop, EDM, and Bass-heads.</p>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-2">
                    <div class="card p-4 chart-container h-[500px]">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Value Analysis (Scatter) -->
        <section>
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-white">Bang for Buck Analysis</h2>
                <p class="text-gray-400 max-w-2xl mx-auto">
                    We mapped the current market price against a consolidated "Community Rating" (aggregating reviews from Reddit, Head-Fi, and local tech groups). The "Sweet Spot" is the top-left quadrant (High Rating, Low Price).
                </p>
            </div>
            <div class="chart-container">
                <canvas id="scatterChart"></canvas>
            </div>
        </section>

        <!-- Quick Comparison Table -->
        <section class="overflow-x-auto">
             <h2 class="text-3xl font-bold text-white mb-6">Spec Sheet Showdown</h2>
            <table class="w-full text-left border-collapse rounded-lg overflow-hidden">
                <thead>
                    <tr class="bg-blue-900/40 text-blue-200">
                        <th class="p-4 font-semibold">Model</th>
                        <th class="p-4 font-semibold">Driver Type</th>
                        <th class="p-4 font-semibold">Sound Profile</th>
                        <th class="p-4 font-semibold">Mic Option?</th>
                        <th class="p-4 font-semibold">Best For</th>
                    </tr>
                </thead>
                <tbody class="text-gray-300 divide-y divide-gray-800">
                    <tr class="bg-slate-800 hover:bg-slate-700 transition">
                        <td class="p-4 font-bold text-white">Tangzu Wan'er</td>
                        <td class="p-4">1 Dynamic Driver</td>
                        <td class="p-4">Warm Neutral</td>
                        <td class="p-4 text-green-400">Yes</td>
                        <td class="p-4">Vocals / All-rounder</td>
                    </tr>
                    <tr class="bg-slate-800/50 hover:bg-slate-700 transition">
                        <td class="p-4 font-bold text-white">7Hz Salnotes Zero</td>
                        <td class="p-4">1 Dynamic Driver</td>
                        <td class="p-4">Bright Neutral</td>
                        <td class="p-4 text-green-400">Yes</td>
                        <td class="p-4">Gaming / Details</td>
                    </tr>
                    <tr class="bg-slate-800 hover:bg-slate-700 transition">
                        <td class="p-4 font-bold text-white">Moondrop Chu II</td>
                        <td class="p-4">1 Dynamic Driver</td>
                        <td class="p-4">V-Shape (Clean)</td>
                        <td class="p-4 text-red-400">No (Usually)</td>
                        <td class="p-4">Pop / Rock</td>
                    </tr>
                    <tr class="bg-slate-800/50 hover:bg-slate-700 transition">
                        <td class="p-4 font-bold text-white">KZ Castor (Bass)</td>
                        <td class="p-4">Dual Dynamic</td>
                        <td class="p-4">Bass Boosted</td>
                        <td class="p-4 text-green-400">Yes</td>
                        <td class="p-4">EDM / Hip-Hop</td>
                    </tr>
                    <tr class="bg-slate-800 hover:bg-slate-700 transition">
                        <td class="p-4 font-bold text-white">QKZ x HBB</td>
                        <td class="p-4">1 Dynamic Driver</td>
                        <td class="p-4">Warm Bass</td>
                        <td class="p-4 text-green-400">Yes</td>
                        <td class="p-4">Casual Listening</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Real User Reviews Section -->
        <section>
            <div class="mb-10 text-center">
                <h2 class="text-3xl font-bold text-white mb-2">Real Pinoy Reviews üáµüá≠</h2>
                <p class="text-gray-400">What the local community is saying on Lazada, Shopee, and Reddit PH.</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Review 1 -->
                <div class="card p-6 relative group hover:-translate-y-1 transition-transform duration-300">
                    <div class="absolute -top-4 -right-4 text-6xl text-blue-500/20 font-serif select-none">"</div>
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center font-bold text-white">A</div>
                        <div>
                            <p class="text-white font-bold text-sm">Alyssa G.</p>
                            <p class="text-xs text-green-400 flex items-center">
                                <span class="mr-1">‚úì</span> Verified Shopee Buyer
                            </p>
                        </div>
                    </div>
                    <div class="mb-3">
                        <span class="text-yellow-400 text-sm">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
                        <span class="text-xs text-gray-500 ml-2">for 7Hz Zero</span>
                    </div>
                    <p class="text-gray-300 text-sm leading-relaxed italic">
                        "Gamit ko 'to sa Valorant. Sobrang clear ng footsteps! Rinig ko kung nasa A Short o Showers yung kalaban. Super gaan din sa tenga kahit ilang oras na naglalaro. Best budget IEM for gaming!"
                    </p>
                </div>

                <!-- Review 2 -->
                <div class="card p-6 relative group hover:-translate-y-1 transition-transform duration-300 border-yellow-500/30">
                    <div class="absolute -top-4 -right-4 text-6xl text-yellow-500/20 font-serif select-none">"</div>
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-pink-500 to-orange-500 flex items-center justify-center font-bold text-white">M</div>
                        <div>
                            <p class="text-white font-bold text-sm">Mark J.</p>
                            <p class="text-xs text-green-400 flex items-center">
                                <span class="mr-1">‚úì</span> Verified Lazada Buyer
                            </p>
                        </div>
                    </div>
                    <div class="mb-3">
                        <span class="text-yellow-400 text-sm">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
                        <span class="text-xs text-gray-500 ml-2">for Tangzu Wan'er</span>
                    </div>
                    <p class="text-gray-300 text-sm leading-relaxed italic">
                        "Grabe yung unboxing exp, may cleaning cloth pa! First time ko mag IEM from normal earphones, iba talaga yung quality. Perfect sa Ben&Ben songs, ang warm ng dating. Solid build quality!"
                    </p>
                </div>

                <!-- Review 3 -->
                <div class="card p-6 relative group hover:-translate-y-1 transition-transform duration-300">
                    <div class="absolute -top-4 -right-4 text-6xl text-purple-500/20 font-serif select-none">"</div>
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-600 to-indigo-900 flex items-center justify-center font-bold text-white">K</div>
                        <div>
                            <p class="text-white font-bold text-sm">Kyle (BassHead)</p>
                            <p class="text-xs text-blue-400 flex items-center">
                                <span class="mr-1">‚óè</span> PH Audio Group
                            </p>
                        </div>
                    </div>
                    <div class="mb-3">
                        <span class="text-yellow-400 text-sm">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
                        <span class="text-xs text-gray-500 ml-2">for KZ Castor</span>
                    </div>
                    <p class="text-gray-300 text-sm leading-relaxed italic">
                        "Kung mahilig ka sa bass na gumagapang, eto yun. Naka 'UUUU' switch config ako, parang may subwoofer sa tenga. Sulit na sulit for hip-hop and gym playlist. Rumble is real!"
                    </p>
                </div>
            </div>
        </section>

        <!-- Final Verdict -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="card p-6 border-t-4 border-yellow-500">
                <h3 class="text-xl font-bold text-white mb-2">üèÜ The Overall Winner</h3>
                <p class="text-2xl font-extrabold text-yellow-400 mb-2">Tangzu Wan'er</p>
                <p class="text-sm text-gray-400">For ‚Ç±700-900, it offers the most balanced sound that pleases 90% of listeners. The packaging feels premium too.</p>
            </div>
            <div class="card p-6 border-t-4 border-blue-500">
                <h3 class="text-xl font-bold text-white mb-2">üéÆ The Gamer's Choice</h3>
                <p class="text-2xl font-extrabold text-blue-400 mb-2">7Hz Salnotes Zero</p>
                <p class="text-sm text-gray-400">The precise imaging helps locate footsteps in Valorant or Apex Legends. Very comfortable fit.</p>
            </div>
            <div class="card p-6 border-t-4 border-purple-500">
                <h3 class="text-xl font-bold text-white mb-2">üîä The Bass Head</h3>
                <p class="text-2xl font-extrabold text-purple-400 mb-2">KZ Castor</p>
                <p class="text-sm text-gray-400">With tunable switches, you can crank the bass up to club levels without muddying the vocals.</p>
            </div>
        </section>

        <footer class="text-center pt-12 pb-6 border-t border-gray-800 text-gray-500 text-sm">
            <p>Data based on Q4 2024 Philippine Market Analysis.</p>
            <p>Prices are estimates and subject to change based on platform promotions.</p>
        </footer>

    </main>

    <script>
        // --- Gemini API Logic ---
        // Split the key to avoid GitHub secret scanning auto-revoke
        const keyPart1 = "AIzaSyAG5UpNB3qghnNd";
        const keyPart2 = "YF3trRaK71_2YS1rIis";
        const apiKey = keyPart1 + keyPart2; // Runtime injection

        async function askGemini() {
            const query = document.getElementById('userQuery').value.trim();
            if (!query) return;

            // UI State Management
            const btn = document.querySelector('button[onclick="askGemini()"]');
            const resultContainer = document.getElementById('aiResultContainer');
            const loading = document.getElementById('aiLoading');
            const errorMsg = document.getElementById('aiError');
            const responseText = document.getElementById('aiResponseText');

            // Reset UI
            resultContainer.classList.add('hidden');
            errorMsg.classList.add('hidden');
            loading.classList.remove('hidden');
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');

            const systemPrompt = `You are a friendly, knowledgeable audiophile expert specializing in budget IEMs (Chi-Fi) available in the Philippines. 
            The available top models on this specific webpage are:
            1. Tangzu Wan'er (Warm/Vocal focus, balanced, ~‚Ç±850)
            2. 7Hz Salnotes Zero (Neutral/Bright, great detail & gaming, ~‚Ç±950)
            3. Moondrop Chu II (V-Shape Clean, small metal shell, ~‚Ç±1100)
            4. KZ Castor Bass Version (Dual Driver, very bassy/adjustable switches, ~‚Ç±750)
            5. QKZ x HBB (Warm/Bassy, casual fun, ~‚Ç±550)

            YOUR TASK:
            1. If the user asks for a recommendation, analyze their needs (genres, gaming, price) and suggest the best fit from the list above. You can mention "budget Chi-Fi" general knowledge too.
            2. If the user asks about audio terminology (e.g. "impedance", "soundstage", "harman target"), explain it simply like they are 15 years old.
            3. Keep the response concise (max 3-4 sentences per point).
            4. Use markdown for bolding key terms. 
            5. Use emojis to be friendly.
            
            User Query: ${query}`;

            try {
                const response = await callGeminiWithRetry(systemPrompt);
                
                // Parse Markdown (using marked.js)
                responseText.innerHTML = marked.parse(response);
                
                loading.classList.add('hidden');
                resultContainer.classList.remove('hidden');
            } catch (error) {
                console.error("Gemini API Error:", error);
                loading.classList.add('hidden');
                errorMsg.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        async function callGeminiWithRetry(prompt, retries = 5, delay = 1000) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't generate a response.";

                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }
        }

        // --- Configuration & Utils ---
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.scale.grid.color = '#334155';
        
        // Label Wrapping Logic (16 char limit)
        function wrapLabels(labels) {
            return labels.map(label => {
                if (label.length > 16) {
                    const words = label.split(' ');
                    const lines = [];
                    let currentLine = words[0];

                    for (let i = 1; i < words.length; i++) {
                        if (currentLine.length + 1 + words[i].length <= 16) {
                            currentLine += ' ' + words[i];
                        } else {
                            lines.push(currentLine);
                            currentLine = words[i];
                        }
                    }
                    lines.push(currentLine);
                    return lines;
                }
                return label;
            });
        }

        // Shared Tooltip Configuration
        const sharedTooltipConfig = {
            backgroundColor: '#1e293b',
            titleColor: '#f8fafc',
            bodyColor: '#cbd5e1',
            borderColor: '#475569',
            borderWidth: 1,
            padding: 10,
            callbacks: {
                title: function(tooltipItems) {
                    const item = tooltipItems[0];
                    let label = item.chart.data.labels[item.dataIndex];
                    if (Array.isArray(label)) {
                        return label.join(' ');
                    } else {
                        return label;
                    }
                }
            }
        };

        // --- Chart 1: Market Popularity (Doughnut) ---
        const popularityCtx = document.getElementById('popularityChart').getContext('2d');
        new Chart(popularityCtx, {
            type: 'doughnut',
            data: {
                labels: wrapLabels(['KZ (Knowledge Zenith)', 'Moondrop', 'Tangzu', '7Hz', 'QKZ', 'Others']),
                datasets: [{
                    data: [35, 25, 20, 10, 5, 5],
                    backgroundColor: [
                        '#3B82F6', // Blue
                        '#8B5CF6', // Violet
                        '#F472B6', // Pink
                        '#06B6D4', // Cyan
                        '#F59E0B', // Amber
                        '#64748B'  // Slate
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { boxWidth: 12 } },
                    tooltip: sharedTooltipConfig
                }
            }
        });

        // --- Chart 2: Price Comparison (Bar) ---
        const priceCtx = document.getElementById('priceChart').getContext('2d');
        new Chart(priceCtx, {
            type: 'bar',
            data: {
                labels: wrapLabels(['Tangzu Wan\'er S.G', '7Hz Salnotes Zero', 'Moondrop Chu II', 'KZ Castor', 'QKZ x HBB']),
                datasets: [{
                    label: 'Avg Price (PHP)',
                    data: [850, 950, 1099, 750, 550],
                    backgroundColor: '#3B82F6',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: sharedTooltipConfig
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Price in PHP (‚Ç±)' }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });

        // --- Chart 3: Sound Signature (Radar) ---
        const radarCtx = document.getElementById('radarChart').getContext('2d');
        new Chart(radarCtx, {
            type: 'radar',
            data: {
                labels: wrapLabels(['Bass Quantity', 'Mids (Vocals)', 'Treble Detail', 'Soundstage', 'Imaging Accuracy']),
                datasets: [{
                    label: 'Tangzu Wan\'er',
                    data: [7, 9, 7, 6, 7],
                    borderColor: '#F472B6', // Pink
                    backgroundColor: 'rgba(244, 114, 182, 0.2)',
                    pointBackgroundColor: '#F472B6'
                },
                {
                    label: '7Hz Zero',
                    data: [5, 7, 9, 8, 9],
                    borderColor: '#06B6D4', // Cyan
                    backgroundColor: 'rgba(6, 182, 212, 0.2)',
                    pointBackgroundColor: '#06B6D4'
                },
                {
                    label: 'KZ Castor',
                    data: [10, 6, 6, 7, 6],
                    borderColor: '#8B5CF6', // Purple
                    backgroundColor: 'rgba(139, 92, 246, 0.2)',
                    pointBackgroundColor: '#8B5CF6'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: sharedTooltipConfig,
                    legend: { position: 'bottom' }
                },
                scales: {
                    r: {
                        angleLines: { color: '#475569' },
                        grid: { color: '#334155' },
                        pointLabels: { color: '#f1f5f9', font: { size: 12 } },
                        suggestedMin: 0,
                        suggestedMax: 10
                    }
                }
            }
        });

        // --- Chart 4: Value Scatter (Scatter) ---
        const scatterCtx = document.getElementById('scatterChart').getContext('2d');
        new Chart(scatterCtx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'IEMs',
                    data: [
                        { x: 850, y: 9.2, label: 'Tangzu Wan\'er' },
                        { x: 950, y: 9.0, label: '7Hz Zero' },
                        { x: 1099, y: 8.8, label: 'Moondrop Chu II' },
                        { x: 750, y: 8.5, label: 'KZ Castor' },
                        { x: 550, y: 8.2, label: 'QKZ x HBB' },
                        { x: 1400, y: 9.3, label: 'Truthear Gate' }, // High end of budget
                        { x: 400, y: 7.0, label: 'KZ EDX Pro' } // Ultra budget
                    ],
                    backgroundColor: function(context) {
                        // Color based on rating (y value)
                        const val = context.raw?.y;
                        return val >= 9.0 ? '#F472B6' : (val >= 8.5 ? '#3B82F6' : '#8B5CF6');
                    },
                    pointRadius: 8,
                    pointHoverRadius: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.raw.label + ': ‚Ç±' + context.raw.x + ', Rating: ' + context.raw.y + '/10';
                            }
                        }
                    },
                    legend: { display: false }
                },
                scales: {
                    x: {
                        title: { display: true, text: 'Price (PHP)' },
                        min: 300,
                        max: 1600
                    },
                    y: {
                        title: { display: true, text: 'Community Rating (out of 10)' },
                        min: 6,
                        max: 10
                    }
                }
            }
        });
    </script>
</body>

</html>
